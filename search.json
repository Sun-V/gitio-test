[{"title":"持久卷的动态卷配置及通过Statefulset部署应用","url":"/2021/08/23/持久卷的动态卷配置及通过Statefulset部署应用/","content":"\n# 1. 搭建NFS服务器\nNFS服务器的搭建参考了[K8s持久化存储【使用NFS】](https://www.huaweicloud.com/articles/c2b03c66245eec9ed1833f3e7e736a50.html) 、[CentOS 7 下 yum 安装和配置 NFS](https://qizhanming.com/blog/2018/08/08/how-to-install-nfs-on-centos-7) 两篇文章，其中要注意客户端部分的安装需要在K8s所有节点进行。  \n本文中NFS服务器的IP为：192.168.111.103，共享目录为/data，相对应地，/etc/exports中添加内容为\n`/data/     192.168.111.0/24(insecure,rw,sync,no_root_squash,no_all_squash)`\n\n以下内容主要参考了[程立笔记](https://segmentfault.com/a/1190000024512057)以及《kubernetes in action中文版》\n# 2. 创建RBAC授权\n创建provisioner的ServiceAccount，并对其进行RBAC授权。\n```\n# rbac.yaml\n\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: nfs-client-provisioner\n  # replace with namespace where provisioner is deployed\n  namespace: default\n---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: nfs-client-provisioner-runner\nrules:\n  - apiGroups: [\"\"]\n    resources: [\"persistentvolumes\"]\n    verbs: [\"get\", \"list\", \"watch\", \"create\", \"delete\"]\n  - apiGroups: [\"\"]\n    resources: [\"persistentvolumeclaims\"]\n    verbs: [\"get\", \"list\", \"watch\", \"update\"]\n  - apiGroups: [\"storage.k8s.io\"]\n    resources: [\"storageclasses\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n  - apiGroups: [\"\"]\n    resources: [\"events\"]\n    verbs: [\"create\", \"update\", \"patch\"]\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: run-nfs-client-provisioner\nsubjects:\n  - kind: ServiceAccount\n    name: nfs-client-provisioner\n    # replace with namespace where provisioner is deployed\n    namespace: default\nroleRef:\n  kind: ClusterRole\n  name: nfs-client-provisioner-runner\n  apiGroup: rbac.authorization.k8s.io\n---\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: leader-locking-nfs-client-provisioner\n  # replace with namespace where provisioner is deployed\n  namespace: default\nrules:\n  - apiGroups: [\"\"]\n    resources: [\"endpoints\"]\n    verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\"]\n---\nkind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  name: leader-locking-nfs-client-provisioner\n  # replace with namespace where provisioner is deployed\n  namespace: default\nsubjects:\n  - kind: ServiceAccount\n    name: nfs-client-provisioner\n    # replace with namespace where provisioner is deployed\n    namespace: default\nroleRef:\n  kind: Role\n  name: leader-locking-nfs-client-provisioner\n  apiGroup: rbac.authorization.k8s.io\n  ```\n# 3. 创建StorageClass\n```\n# storageclass-nfs.yaml\n\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: managed-nfs-storage\nprovisioner: fuseim.pri/ifs\nparameters:\n  archiveOnDelete: \"false\"\n```\n# 4. 创建provisioner\n```\n# nfs-client-provisioner.yaml\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nfs-client-provisioner\n  labels:\n    app: nfs-client-provisioner\n  # replace with namespace where provisioner is deployed\n  namespace: default\nspec:\n  replicas: 1\n  strategy:\n    type: Recreate\n  selector:\n    matchLabels:\n      app: nfs-client-provisioner\n  template:\n    metadata:\n      labels:\n        app: nfs-client-provisioner\n    spec:\n      serviceAccountName: nfs-client-provisioner\n      containers:\n        - name: nfs-client-provisioner\n          image: sunjqv/nfs-subdir-external-provisioner:v4.0.0\n          volumeMounts:\n            - name: nfs-client-root\n              mountPath: /persistentvolumes\n          env:\n            - name: PROVISIONER_NAME\n              value: fuseim.pri/ifs\n            - name: NFS_SERVER\n              # 替换为自己NFS的ip\n              value: 192.168.111.103\n            - name: NFS_PATH\n              value: /data\n      volumes:\n        - name: nfs-client-root\n          nfs:\n            # 注意替换ip\n            server: 192.168.111.103\n            path: /data\n```\n在网上许多文章中，spec.template.spec.containers.image配置的provisioner不再适合1.20.0+版本的k8s，会出现无法动态构建pv的问题，具体问题信息表现为\n```\n[root@master k8sfiles]# kubectl describe pvc data-kubia-0\nName:          data-kubia-0\nNamespace:     default\nStorageClass:  managed-nfs-storage\nStatus:        Pending\nVolume:        \nLabels:        app=kubia\nAnnotations:   volume.beta.kubernetes.io/storage-provisioner: fuseim.pri/ifs\nFinalizers:    [kubernetes.io/pvc-protection]\nCapacity:      \nAccess Modes:  \nVolumeMode:    Filesystem\nUsed By:       kubia-0\nEvents:\n  Type    Reason                Age                 From                         Message\n  ----    ------                ----                ----                         -------\n  Normal  ExternalProvisioning  6s (x10 over 2m2s)  persistentvolume-controller  waiting for a volume to be created, either by external provisioner \"fuseim.pri/ifs\" or manually created by system administrator\n\n```\n\n```\n#查看对应pod的日志\n\n[root@master k8sfiles]# kubectl logs -f nfs-client-provisioner-9547dc76b-6g4wj \nI0819 01:26:01.017938       1 leaderelection.go:185] attempting to acquire leader lease  default/fuseim.pri-ifs...\nE0819 01:26:18.445583       1 event.go:259] Could not construct reference to: '&v1.Endpoints{TypeMeta:v1.TypeMeta{Kind:\"\", APIVersion:\"\"}, ObjectMeta:v1.ObjectMeta{Name:\"fuseim.pri-ifs\", GenerateName:\"\", Namespace:\"default\", SelfLink:\"\", UID:\"c55af7a2-b250-4c45-9cb2-19aa95610dbf\", ResourceVersion:\"1083335\", Generation:0, CreationTimestamp:v1.Time{Time:time.Time{wall:0x0, ext:63764873777, loc:(*time.Location)(0x1956800)}}, DeletionTimestamp:(*v1.Time)(nil), DeletionGracePeriodSeconds:(*int64)(nil), Labels:map[string]string(nil), Annotations:map[string]string{\"control-plane.alpha.kubernetes.io/leader\":\"{\\\"holderIdentity\\\":\\\"nfs-client-provisioner-9547dc76b-6g4wj_69af896c-008c-11ec-b671-620ce41148af\\\",\\\"leaseDurationSeconds\\\":15,\\\"acquireTime\\\":\\\"2021-08-19T01:26:18Z\\\",\\\"renewTime\\\":\\\"2021-08-19T01:26:18Z\\\",\\\"leaderTransitions\\\":2}\"}, OwnerReferences:[]v1.OwnerReference(nil), Initializers:(*v1.Initializers)(nil), Finalizers:[]string(nil), ClusterName:\"\"}, Subsets:[]v1.EndpointSubset(nil)}' due to: 'selfLink was empty, can't make reference'. Will not report event: 'Normal' 'LeaderElection' 'nfs-client-provisioner-9547dc76b-6g4wj_69af896c-008c-11ec-b671-620ce41148af became leader'\nI0819 01:26:18.445645       1 leaderelection.go:194] successfully acquired lease default/fuseim.pri-ifs\nI0819 01:26:18.445737       1 controller.go:631] Starting provisioner controller fuseim.pri/ifs_nfs-client-provisioner-9547dc76b-6g4wj_69af896c-008c-11ec-b671-620ce41148af!\nI0819 01:26:18.546716       1 controller.go:680] Started provisioner controller fuseim.pri/ifs_nfs-client-provisioner-9547dc76b-6g4wj_69af896c-008c-11ec-b671-620ce41148af!\nI0819 01:39:26.997185       1 controller.go:987] provision \"default/data-kubia-0\" class \"managed-nfs-storage\": started\nE0819 01:39:27.006858       1 controller.go:1004] provision \"default/data-kubia-0\" class \"managed-nfs-storage\": unexpected error getting claim reference: selfLink was empty, can't make reference\nI0819 01:41:18.449551       1 controller.go:987] provision \"default/data-kubia-0\" class \"managed-nfs-storage\": started\nE0819 01:41:18.452684       1 controller.go:1004] provision \"default/data-kubia-0\" class \"managed-nfs-storage\": unexpected error getting claim reference: selfLink was empty, can't make reference\n\n```\n即pvc在“waiting for a volume to be created”，错误原因则是“selfLink was empty, can't make reference”。经过搜索得知，原来selfLink已经在k8sv1.20.0及以后的版本上弃用，[这里](https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/issues/25)也给出了新的provisioner image：`gcr.io/k8s-staging-sig-storage/nfs-subdir-external-provisioner:v4.0.0`。但由于gcr.io在大陆访问不便，在上面的yaml文件中，我将其替换成了dockerhub镜像：sunjqv/nfs-subdir-external-provisioner:v4.0.0。\n\n# 5. 创建Statefulset\n在部署Statufulset之前，创建一个用于在有状态的pod之间提供网络标识的headless Service\n```\n# kubia-svc-headless.yaml\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: kubia\n  labels:\n    app: kubia\nspec:\n  ports:\n  - port: 80\n    name: http\n  clusterIP: None\n  selector:\n    app: kubia\n```\n最后创建Statefulset\n\n```\n# kubia-statefulset\n\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: kubia\nspec:\n  serviceName: kubia\n  replicas: 2\n  selector:\n    matchLabels:\n      app: kubia # has to match .spec.template.metadata.labels\n  template:\n    metadata:\n      labels:\n        app: kubia\n    spec:\n      terminationGracePeriodSeconds: 10\n      serviceAccount: nfs-client-provisioner\n      containers:\n      - name: kubia\n        image: luksa/kubia-pet\n        ports:\n        - containerPort: 8080\n          name: http\n        volumeMounts:\n        - name: data\n          mountPath: /var/data\n  volumeClaimTemplates:\n  - metadata:\n      name: data      \n    spec:\n      storageClassName: managed-nfs-storage\n      accessModes:\n      - ReadWriteOnce\n      resources:\n        requests:\n          storage: 10Mi\n```\n两个pods依次创建\n```\n[root@master k8sfiles]# kubectl get po\nNAME                                      READY   STATUS              RESTARTS   AGE\nkubia-0                                   0/1     ContainerCreating   0          53s\nnfs-client-provisioner-774645ccfd-p9l8w   1/1     Running             0          77s\n[root@master k8sfiles]# kubectl get po\nNAME                                      READY   STATUS              RESTARTS   AGE\nkubia-0                                   1/1     Running             0          71s\nkubia-1                                   0/1     ContainerCreating   0          15s\nnfs-client-provisioner-774645ccfd-p9l8w   1/1     Running             0          95s\n[root@master k8sfiles]# kubectl get po\nNAME                                      READY   STATUS    RESTARTS   AGE\nkubia-0                                   1/1     Running   0          95s\nkubia-1                                   1/1     Running   0          39s\nnfs-client-provisioner-774645ccfd-p9l8w   1/1     Running   0          119s\n```\npvc和pv已经是bound状态\n```\n[root@master k8sfiles]# kubectl get pvc\nNAME           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS          AGE\ndata-kubia-0   Bound    pvc-25b1d7ef-0b77-45b4-beda-5478628f64c8   10Mi       RWO            managed-nfs-storage   47m\ndata-kubia-1   Bound    pvc-3405016b-5f57-499c-b418-3b8438e94551   10Mi       RWO            managed-nfs-storage   46m\n[root@master k8sfiles]# kubectl get pv\nNAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                  STORAGECLASS          REASON   AGE\npvc-25b1d7ef-0b77-45b4-beda-5478628f64c8   10Mi       RWO            Delete           Bound    default/data-kubia-0   managed-nfs-storage            47m\npvc-3405016b-5f57-499c-b418-3b8438e94551   10Mi       RWO            Delete           Bound    default/data-kubia-1   managed-nfs-storage            47m\n```\n","tags":["k8s"]},{"title":"索尼Xperia XZ2刷入Lineage 17.1教程","url":"/2020/07/20/索尼Xperia-XZ2刷入Lineage-17-1教程/","content":"\n因为此ROM已经获得了Lineage官方的支持，直接刷入official-build版可以在线OTA更新，所以原来的教程就没有太大意义了。下面介绍直接刷入official-build版的步骤。\n\n\n# 直接刷入official-build\n\n0.1. 确保手机已经升级到了官方Android 10并且至少启动一次，确保手机已经解锁；\n\n0.2. 通过[此链接](https://sunv.lanzoui.com/igJLQeris8f)下载platform-tools R28并解压，进入platform-tools文件夹，此目录下打开命令窗口；\n\n0.3. 通过[此链接](https://sunv.lanzoui.com/iUPptez4r9e)下载vbmeta.img，在[此页面](https://download.lineageos.org/akari)下载Lineage Recovery和lineage-17.1包，通过[此链接](https://androidfilehost.com/?fid=4349826312261712574)下载copy-partitions.zip，都放入platform-tools文件夹内；\n\n0.4. 音量增加键进入蓝灯模式（或者`adb reboot bootloader`进入），在命令窗口输入\n\n```\nfastboot --disable-verity --disable-verification flash vbmeta vbmeta.img\nfastboot flash boot <recovery_filename>.img\n```\n\n0.5. 去除数据线，音量降低键+电源键进入rec，使用音量键选择，并用电源键确定选择Apply update - Apply from ADB，连接数据线，使用`adb sideload copy-partitions.zip `刷入，刷入时会有报错，直接点击yes即可；\n\n0.6. 回到主界面，选择并确定Factory Reset,  Format data / factory reset 格式化数据；\n\n0.7. 回到主界面，选择并确定Apply update - Apply from ADB，连接数据线，使用`adb sideload lineage-xxxxx.zip `刷入LineageOS包；\n\n0.8. 若不需要GApps，root权限等，可直接开机；\n\n0.9. 若需要刷入其他包，选择Advanced - Reboot to Recovery，按0.7. 步骤刷入即可（注：GApps需要在第一次开机之前刷入）；\n\n0.10. 需要索尼相机，需要在[这里](https://androidfilehost.com/?w=files&flid=315674)下载，刷入SemcCamera-xxx.zip和Magisk-xxx.zip后，在Magisk中安装selinux_permissive_v2.0_evdenis.zip 。\n\n分割线以下是原文。\n\n****\n\n建议进行以下操作前对手机内重要数据进行备份，退出SIM卡和消除Google帐号。若执行完下述操作出现卡SONY或无限重启等问题，建议按照步骤仔细地重新刷入。以下操作中，使用第三方固件为[Sjll](https://forum.xda-developers.com/member.php?u=8321130)的[基于官方的LineageOS 17.1](https://forum.xda-developers.com/xperia-xz2/development/pre-official-lineage-17-1-xperia-xz2-t4089775)，与之对应，使用底包为[52.1.A.2.1](https://pan.baidu.com/s/1CBlg7mj4ztFAksFJGzKVLA)（提取码：l98l）。\n\n本文工作主要是对已有的操作步骤进行翻译和说明等，并非具有原创性，读者可进入以下直接或间接使用的项目进行支持：\n\n+ [[STOCK][ROM][Pre-Official]Lineage 17.1 for Xperia XZ2 [RC]](https://forum.xda-developers.com/xperia-xz2/development/pre-official-lineage-17-1-xperia-xz2-t4089775)\n\n+ [Official LineageOS website](http://lineageos.org)\n\n+ [Magisk - The Magic Mask for Android](https://forum.xda-developers.com/apps/magisk/official-magisk-v7-universal-systemless-t3473445/page6)\n\n# 1. 解锁\n\n关于解锁操作，可以参考[这篇教程](https://sun-v.github.io/2019/11/03/%E7%B4%A2%E5%B0%BCXperia-XZ2%E5%88%B7%E5%85%A5%E7%AC%AC%E4%B8%89%E6%96%B9%E5%9B%BA%E4%BB%B6%E6%95%99%E7%A8%8B/)。\n\n# 2. 强刷底包固件\n\n强刷操作同样可参考1中给出的链接。刷入结束后，断开数据线，启动系统至桌面。\n\n# 3. 刷入VoLTE\n\n若不需要VoLTE，此步骤可跳过。\n\n关机后通过音量降低键进入绿灯模式，在[此链接](https://sunv.lanzoui.com/i1ziLeri7hi)中下载oem.zip，解压后进入oem文件夹，打开newflash.exe，输入两次n并回车，出现“请按任意键继续”说明刷入完成。开机，使得状态栏出现VoLTE的标识。\n\n# 4. 刷入LineageOS\n\n4.1 在[此界面](https://androidfilehost.com/?fid=4349826312261819306)下载[Beta]-lineage-17.1-akari-2020-5-26-sjll.zip；通过[此链接](https://sunv.lanzoui.com/igJLQeris8f)下载platform-tools R28并解压。将[Beta]-lineage-17.1-akari-2020-5-26-sjll.zip解压后的所有文件放入到platform-tools文件夹中。\n\n4.2 关机后通过音量增加键进入蓝灯模式，进入platform-tools文件夹，在文件资源管理器地址栏输入cmd回车进入命令行窗口，依次输入并回车下面命令\n\n```\nfastboot flash boot boot.img\nfastboot flash vendor vendor.img\nfastboot flash system system.img\nfastboot flash dtbo dtbo.img\nfastboot --disable-verity --disable-verification flash vbmeta vbmeta.img\n```\n\n第一次使用LineageOS还需要\n\n```\nfastboot flash userdata userdata.img\n```\n\n若仅是体验，可跳过下面步骤开机使用。\n\n# 5. 刷入更新包\n\n5.1 在[此页面](https://androidfilehost.com/?w=files&flid=313749)下载更新包，并将压缩包放入platform-tools文件夹中。\n\n5.2 断开数据线，按住音量降低键和电源键开机进入lineage recovery，使用音量键和电源键选择“Apply update - Apply from ADB”，连接数据线，使用`adb sideload lineage-xxxxx.zip `刷入更新包。\n\n若不需要GApps，索尼相机，root权限，可以跳过下面操作。\n\n# 6. 其他\n\n6.1 可在[此界面](https://github.com/topjohnwu/Magisk/releases/tag/v20.4)下载Magisk-v20.4.zip，在[此界面](http://opengapps.org/)依ARM64->Android 10.0->Pico, Nano or Micro下载Gapps，在[此界面](https://androidfilehost.com/?fid=4349826312261816722)下载索尼相机。\n\n6.2 将所需刷入的压缩包放入platform-tools文件夹中，和刷入更新包的方式一样，使用adb sideload命令刷入。注意，Gapps需要在刷入LineageOS第一次开机之前刷入，索尼相机和Magisk刷入更新包后需要启动一次后再刷入；刷入时会有报错，直接点击yes即可；开机之后的安全中心警报可划走忽略。\n","tags":["Android"]},{"title":"索尼Xperia XZ2刷入eXistenZ-Quindim教程","url":"/2020/05/26/索尼Xperia-XZ2刷入eXistenZ-Quindim教程/","content":"\n建议进行以下操作前对手机内重要数据进行备份，退出SIM卡和消除Google帐号。若执行完下述操作出现卡SONY或无限重启等问题，建议按照步骤仔细地重新刷入。以下操作中，使用第三方固件为[niaboc79](https://forum.xda-developers.com/member.php?u=599722)的[eXistenZ Quindim v1.0.0](https://forum.xda-developers.com/xperia-xz2/development/rom-existenz-quindim-v1-0-0-06-05-20-t4095403)，与之对应，使用底包为[52.1.A.0.618](http://bbs.gfan.com/android-9637543-1-1.html)。\n\n文中所需文件可在[此](https://pan.baidu.com/s/1Q6sWwdnV9z6-gkyqbbgzDQ)下载(提取码：4ywp)。若链接失效，可在下文中用到文件的位置使用原链接下载（需要翻墙操作）\n\n注：若对诸如cmd中cd到某路径等一些基本操作不熟悉，建议先使用搜索引擎学习或放弃进行下述操作。\n\n本文工作主要是对已有的操作步骤进行翻译和说明等，并非具有原创性，读者可进入以下直接或间接使用的项目进行支持：\n\n+ [[ROM][STOCK][XZ2][XZ2C][XZ2P] eXistenZ Quindim | v1.0.0 | 06/05/20](https://forum.xda-developers.com/xperia-xz2/development/rom-existenz-quindim-v1-0-0-06-05-20-t4095403)\n\n+ [[RECOVERY][Android 10][Stock/SODP][XZ2/C/P/3] TWRP 3.3.1-0 [UNofficial]](https://forum.xda-developers.com/xperia-xz2/development/recovery-twrp-3-3-1-0-t4074305)\n\n+ [Magisk - The Magic Mask for Android](https://forum.xda-developers.com/apps/magisk/official-magisk-v7-universal-systemless-t3473445/page6)\n\n# 1. 解锁\n\n关于解锁操作，可以参考[这篇教程](https://sun-v.github.io/2019/11/03/%E7%B4%A2%E5%B0%BCXperia-XZ2%E5%88%B7%E5%85%A5%E7%AC%AC%E4%B8%89%E6%96%B9%E5%9B%BA%E4%BB%B6%E6%95%99%E7%A8%8B/)。\n\n# 2. 强刷底包固件\n\n强刷操作同样可参考1中给出的链接。刷入结束后，断开数据线，启动系统至欢迎使用界面。\n\n# 3. 启动TWRP\n\n本文百度盘链接中的platform-tools.zip已经将TWRP所需img文件放入到platform tools文件夹中，下面表述以此为基础。读者也可自己分别在[此](https://developer.android.com/studio/releases/platform-tools)下载platform-tools，在[此](https://www.dhsfileserver.de/ftp/martinx3/)下载TWRP。\n\n解压platform-tools.zip，打开windows命令处理程序，cd到platform-tools目录下（具体可参考1给出链接中的相关操作或使用搜索引擎）。连接数据线，输入下面的命令使手机重启至蓝灯模式(请勿使用按住音量键和电源键的方式进入)：\n\n```\nadb reboot bootloader\n```\n\n接着输入下面两条命令，等待手机自动启动TWRP：\n\n```\nfastboot --disable-verity --disable-verification flash vbmeta vbmeta.img\nfastboot boot twrp.img\n```\n\n若出现无法触控的情况，快速地点击电源键几次至TWRP重启，问题可解决。为方便进行文件传输，需保证mount中右下角为Enable MTP，将下面需要刷入的卡刷包拷贝到手机存储中。\n\n# 4. 刷入卡刷包\n\n4.1 进入settings，将“unmount system before flashing”取消选中。\n\n4.2 在mount中，将System选中，将[eXistenZ Quidim cleaner](https://drive.google.com/open?id=1beR0TeEeR_Iii29n-6xEzMGGPsnCBWaO)刷入。\n\n4.3 点击reboot system，出现下图界面，点击do not install。\n\n![TWRP](/img/TWRP.png)\n\n4.4 系统并不会正常进入，会无限重启。在电脑检测到设备接入时，输入\n\n```\nadb reboot bootloader\n```\n\n同上面一样，再次使用下面两条命令，并等待手机自动启动TWRP：\n\n```\nfastboot --disable-verity --disable-verification flash vbmeta vbmeta.img\nfastboot boot twrp.img\n```\n\n4.5 将mount中system选中，刷入[eXistenZ Quindim v1.0.0](https://drive.google.com/open?id=1T_QuL9MWBGKU-X4-bBWJQk-T1VOd5QMD)。\n\n4.6 刷入Magisk-vxx.x.zip，若出现红色错误信息，可重新刷入一次。\n\n4.7 选择reboot system，点击do not install，等待系统开机。\n\n","tags":["Android"]},{"title":"索尼Xperia XZ2刷入第三方固件教程","url":"/2019/11/03/索尼Xperia-XZ2刷入第三方固件教程/","content":"建议进行以下操作前对手机内重要数据进行备份，退出SIM卡和消除Google帐号。以下操作中，解锁环境为Android P和Windows 10（~~windows10 2004可能会在蓝灯模式出现问题~~），使用第三方固件为[machao44的v2.1](http://bbs.gfan.com/android-9619914-1-1.html)，与之对应，使用底包为[CN_52.0.A.11.3](http://bbs.gfan.com/android-9619774-1-1.html)。\n\n# 1. 解锁\n\n索尼Xperia如果要使用非官方固件，需要先进行解锁。\n\n## 1.1. 获取解锁码\n\n进入[Xperia解锁页面](https://developer.sony.com/develop/open-devices/get-started/unlock-bootloader/)（需要翻墙操作），在页面最下方选择机型，填入IMEI号，选中前两个选项提交，即可获得解锁码。（无法操作的朋友可进入[论坛此帖](http://bbs.gfan.com/android-9626077-1-1.html)留言或在本帖下方评论处留下机型和imei）\n\n![解锁界面](/img/unlock.jpg)\n\n## 1.2. 安装驱动\n\n安装驱动可使用Flashtool工具和newflasher工具进行，此处使用后者。（Windows 10 2004之后的几个版本按下面步骤应该走不通，需要[禁用驱动签名验证](https://jingyan.baidu.com/article/29697b910f8f59ab20de3c9e.html)，然后安装[flashtool-drivers](https://sunv.lanzoui.com/iuVuNkonada)的前两个驱动：flashmode drivers和fastboot drivers）\n\n下载[newflasher工具](https://forum.xda-developers.com/crossdevice-dev/sony/progress-newflasher-xperia-command-line-t3619426) [（给出newflasher v13版本）](https://sunv.lanzoui.com/iMirsjw952h)，解压缩后运行newflasher.exe，输入y回车后得到GordonGate.7z。解压缩此文件，右键安装ggsomc.inf。再下载并解压缩[对应机型的驱动文件](https://developer.sony.com/develop/drivers/)，右键安装sa118adb.inf文件。\n\n在电脑上打开设备管理器，手机关机，按住音量降低键同时USB接入电脑，手机指示灯为绿色可松开音量键，此时进入绿灯模式（Flashmode）。注意设备管理器中新添加的SOMC Flash Device，如果有黄色叹号，右键选择“更新驱动程序”-“浏览我的计算机以查找驱动程序软件”-“让我从计算机上的可用驱动程序列表中选取”，选择“SOMC Flash Device”。再断开数据线，按住音量增加键同时连接数据线，手机指示灯为蓝色时松开，此时进入蓝灯模式(Fastboot)。和上面步骤类似，对应新添加的是“Sony sa0118 ADB Interface Drive”，有黄色叹号需要在驱动列表中找到”Sonysa0118”安装。（非Windows10操作环境出现不一致的显示情况可通过搜索引擎解决，或更换为Windows 10操作环境）\n\n## 1.3. 强刷非大陆版固件\n\n此步骤应用于国行固件，若此时手机固件已经是非国行版本（港版，印度版等等）了，可跳过此步骤。\n\n① 使用XperiFirm或在论坛下载一非国行固件，将固件解压。\n\n② 将boot文件夹中文件后缀.sinb的改为.sin，将.tab的改为.ta。\n\n③ 将根目录下的boot_delivery.xml移动至boot文件夹内。\n\n④ 将1.2.中newflasher文件夹中的七个newflasher文件复制到固件文件夹中。\n\n⑤ 检查是否有simlock.ta和fwinfo.xml文件，若有，删掉。\n\n⑥ 将partition.zip解压。\n\n⑦ 按住音量降低键进入绿灯模式,管理员模式运行newflasher.exe，输入两次n并回车，出现“请按任意键继续”说明刷入完成。\n\n## 1.4. OEM解锁\n\n点击设置-系统-关于手机-版本号多次，直到出现开发者模式。在系统-开发者选项中打开OEM解锁。\n\n## 1.5. 使用解锁码进行解锁\n\n下载platform-tools（[[r25]](https://dl.google.com/android/repository/platform-tools_r25-windows.zip) [[r28]](https://sunv.lanzoui.com/igJLQeris8f)如果使用r25遇到未识别的命令等问题，可以选择r28）并解压缩，打开windows命令处理程序（win10下右击win图标选择命令提示符，或者win+R，输入cmd回车），cd到adb.exe所在目录下（更方便的方式是文件资源管理器中打开目录，然后在地址栏直接输入cmd回车），如下图。\n\n![命令处理程序](/img/cdadb.jpg)\n\n进入蓝灯模式，输入\n\n`fastboot devices`\n\n回车，再输入\n\n`fastboot oem unlock 0x此处为解锁码`\n\n即可解锁。\n\n# 2. 线刷底包和卡刷第三方固件\n\n## 2.1. 线刷底包固件\n\n底包是第三方作者进行增强操作的基础包，如下图中的第三方固件是基于官方的52.0.A.11.3进行修改的。\n\n![底包说明](/img/底包.jpg)\n\n线刷底包固件操作同1.3.，刷完不要开机。\n\n## 2.2. 刷入Recovery\n\n此步骤和[机锋论坛中的root教程](http://bbs.gfan.com/forum.php?mod=viewthread&tid=9513429&extra=page%3D1%26filter%3Dtypeid%26typeid%3D12976%26typeid%3D12976)一致，且所需工具亦来源于同一帖。\n\n① 下载帖子中的隐藏资源，将其中的XZ2-2C-root.zip解压。进入其中的adb文件夹，打开windows命令处理程序，cd到此目录下（参考1.5.）。\n\n② 进入蓝灯模式（音量增加键连接电脑），输入下面的命令并回车\n\n```\nfastboot flash boot twrp-xz2.img\nfastboot --disable-verity --disable-verification flash vbmeta vbmeta.img\n```\n\n③ 断开数据线，同时按住音量降低键和电源键，会进入TWRP Recovery，点击挂载，启用MTP模式。点击home键可返回到初始界面。（~~下面几步主要是对底包进行root，故可以直接跳过，进行2.3.~~ 保险起见，还是全刷了吧）\n\n④ 将底包文件夹中的以boot_X开头的sin文件用鼠标拖动到XZ2-2C-root文件夹下的UnSIN.exe文件上，会在底包文件夹中出现同名的img文件，将其改名为kernel.img并移动到XZ2-2C-root下的boot文件夹内，压缩boot文件夹为boot.zip。\n\n![UnSIN](/img/UnSIN.jpg)\n\n注意，boot.zip打开如下图所示，一个文件夹和一个文件。\n\n![boot](/img/boot.jpg)\n\n⑤ 将boot.zip，对应底包版本文件夹内的twrp-installer-xz2-2c-3.2.3.zip（不对应版本会使twrp无法触控），Magisk-v17.2.zip，fstab.zip复制到手机存储，依次使用twrp安装刷入。\n\n⑥ 开机，正常进入之后关机再次进入twrp，将permissive.zip复制到手机存储，刷入。开机。\n\n## 2.3. 卡刷第三方固件\n\n① 将下载好的XPERIA_PIE_XZ2_2.1.zip、1-Magisk.zip和2-Permissive.zip以及其他需要使用的卡刷包复制到手机存储或外置SD卡。\n\n② 关机进入twrp，点击清除，滑动下方按钮完成双清。\n\n③ 点击安装，选择XPERIA_PIE_XZ2_2.1.zip开始刷入。\n\n④ 再依次刷入1-Magisk.zip和2-Permissive.zip。\n\n⑤ 看论坛评论此版本谷歌框架的使用有问题，因此再刷入delete google.zip。\n\n⑥ 平时使用谷歌套件可去[OpenGAPPS](https://opengapps.org/)下载对应卡刷包刷入。Platform选择ARM64，Android选择9.0，Variant可按需选择（各选项的差别可参考[这里](https://www.zybuluo.com/wddzzz/note/733197#%E4%B8%80opengapps-app%E6%99%BA%E8%83%BD%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85-%E6%8E%A8%E8%8D%90)）。注意不要在此Rec下使用aroma，亲测无法弹出自定义图形界面。\n\n⑦ 开机。","tags":["Android"]},{"title":"小狼毫输入法模糊音配置","url":"/2019/10/19/小狼毫输入法模糊音配置/","content":"小狼毫输入法的模糊音[配置](https://github.com/rime/home/wiki/CustomizationGuide)是有明月拼音的[定制模板](https://gist.github.com/lotem/2320943)的，但微软双拼输入方案在这一设置下并不会生效，需要做一些调整。\n\n明月拼音模板中代码添加位置是在“luna_pinyin.custom.yaml”下，但双拼方案修改“.custom.yaml”无效。应当修改用户文件夹下“double_pinyin_mspy.schema.yaml”文件（其他输入方案修改对应“.schema.yaml”文件），在“speller/algebra”\n下添加如下代码：\n\n```\n- abbrev/^([az]).+$/$1/ #简拼（首字母）\n- abbrev/^([zcs]h).+$/$1/ #简拼（zh, ch, sh） \n- derive/^([zcs])h/$1/ # zh, ch, sh => z, c, s\n- derive/^([zcs])([^h])/$1h$2/ # z, c, s => zh, ch, sh\n- derive/([aei])n$/$1ng/ # en => eng, in => ing\n- derive/([aei])ng$/$1n/ # eng => en, ing => in\n- derive/([iu])an$/$lang/ # ian => iang, uan => uang\n- derive/([iu])ang$/$lan/ # iang => ian, uang => uan\n```\n\n注意要将代码添加至“xform”代码段之前，如下：\n![代码添加](/img/小狼毫_添加代码.jpg)\n\n重新部署之后即可使用模糊音。\n","tags":["Software"]},{"title":"田英章硬笔书法视频示范","url":"/2019/07/10/田英章硬币书法视频示范/","content":"\n附上1990年田英章书写字帖《钢笔楷书使用技法字帖》：点此下载（此链接已移除，字帖添加到了下行链接中）\n\n更新一批电子字帖，主要是古人经典作品：[点此下载](https://sunv.lanzoui.com/b00tojc9e)\n\n如果想把视频下载下来，可以参考[这里](https://github.com/Sun-V/m3u8Downloader)（需要配置python2.7环境）\n\n0.[练字方法](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index1.htm)\n\n1.[点](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index2.htm)\n\n2.[横](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index3.htm)\n\n3.[竖](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index4.htm)\n\n4.[撇、提](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index5.htm)\n\n5.[捺](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index6.htm)\n\n6.[横钩、竖钩、斜钩、卧钩、弧弯钩](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index7.htm)\n\n7.[竖折、横折、撇折、横折钩、竖弯钩](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index8.htm)\n\n8.[撇点、横折弯钩、横折折折钩、竖折折钩](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index9.htm)\n\n9.[两点水、三点水](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index10.htm)\n\n10.[单人旁、双人旁、竖心旁、巾字旁](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index11.htm)\n\n11.[土字旁、王字旁、山字旁](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index12.htm)\n\n12.[木字旁、禾字旁、米字旁、示字旁、衣字旁](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index13.htm)\n\n13.[马字旁、弓字旁、月字旁](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index14.htm)\n\n14.[虫字旁、左耳刀](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index15.htm)\n\n15.[日字旁、目字旁、石字旁](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index16.htm)\n\n16.[食字旁、金字旁、绞丝旁](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index17.htm)\n\n17.[火字旁、反犬旁、歹字旁、豸字旁](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index18.htm)\n\n18.[车字旁](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index19.htm)\n\n19.[女字旁、反文旁、隹字旁](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index20.htm)\n\n20.[力字旁、殳字旁](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index21.htm)\n\n21.[右耳刀、单耳刀、立刀旁、三撇儿](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index22.htm)\n\n22.[宝盖头、秃宝盖、穴宝盖](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index23.htm)\n\n23.[人字头、大字头](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index24.htm)\n\n24.[草字头、竹字头、爪字头、四字头](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index25.htm)\n\n25.[广字头、病字头、虎字头](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index26.htm)\n\n26.[四点底、心字底、女字底](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index27.htm)\n\n27.[走之底、建字底、走字底](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index28.htm)\n\n28.[区字框、句字框、画字框](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index29.htm)\n\n29.[门字框、国字框](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index30.htm)\n\n中间页码丢失是因为字帖上有的几页字体结构没有二维码，也没找到对应视频。\n\n36.[首点居正、通变顾盼](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index37.htm)\n\n37.[点竖直对、中直对正](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index38.htm)\n\n38.[中直偏右、竖笔等距](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index39.htm)\n\n39.[横笔等距、底竖斜位](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index40.htm)\n\n40.[上收下展、上展下收](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index41.htm)\n\n41.[上正下斜、上斜下正](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index42.htm)\n\n42.[下方迎就、左收右放](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index43.htm)\n\n43.[左斜右正、对等平分](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index44.htm)\n\n44.[左右对称、主笔脊柱](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index45.htm)\n\n45.[中宫收紧、收缩纵展](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index46.htm)\n\n46.[大小独具、联撇参差](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index47.htm)\n\n47.[三部呼应、钩趯匕刃](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index48.htm)\n\n48.[围而不堵、斜抱穿插](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index49.htm)\n\n49.[章法](http://www.scwj.net/media/video/changxiao/zhengkaiyibentong/index50.htm)\n","tags":["Others"]},{"title":"LyX中插入代码缩进格式失效问题的解决办法","url":"/2019/06/29/LyX中插入代码缩进格式失效问题的解决办法/","content":"最近在使用LyX编写课程作业，在插入代码时，发现Ctrl+V到程序列表的代码的缩进格式都失效了，如下所示：\n![代码缩进问题](/img/代码缩进问题.jpg)\n\nWindows系统下使用Ctrl+Shift+V，MacOS下使用Command+Shift+V可以保持原有的缩进格式。\n![维持原有缩进格式](/img/维持原有缩进格式.jpg)","tags":["LyX"]},{"title":"访问谷歌xx出现but your computer or network may be sending automated queries问题的解决办法","url":"/2019/06/02/访问谷歌xx出现but-your-computer-or-network-may-be-sending-automated-queries问题的解决办法/","content":"刚进六月，由于不可说的原因，之前VPS的IP废掉了。使用新的IP访问谷歌学术时，却出现了如题目所示的问题。经过搜索，得知原因是我使用的IPv4网段被封掉了，所以解决办法就是强制VPS使用IPv6访问谷歌学术。\n\n方法是在hosts中指定谷歌学术的IPv6地址。\n首先需要VPS支持IPv6。我使用的是vultr，在server information界面，点进Settings-IPv6进行分配地址，然后修改hosts文件。\n\n`sudo nano /etc/hosts`\n\n在hosts文件中加入\n```\n## Scholar 学术搜索\n2404:6800:4008:c06::be scholar.google.com\n2404:6800:4008:c06::be scholar.google.com.hk\n2404:6800:4008:c06::be scholar.google.com.tw\n2404:6800:4005:805::200e scholar.google.cn #www.google.cn\n```\n可以在[这里](https://raw.githubusercontent.com/lennylxx/ipv6-hosts/master/hosts)获取最新的IPv6地址\n","tags":["VPS"]},{"title":"软件中打开的新窗口不显示问题的解决办法（以Altium Designer Summer 09 为例）","url":"/2019/05/27/软件中打开的新窗口不显示问题的解决办法（以Altium-Designer-Summer-09-为例）/","content":"前两天上课使用到了古老的Altium Designer Summer09，在SCH Library栏打算对组件信息进行编辑时，“Library Component Properties”窗口死活打不开。起始以为是版本问题，但使用同版本软件同Windows 10版本的同学没问题；后来认为是.net Framework版本的原因，但开启低版本后问题依旧。\n\n最后，我把关注点转移到了一般软件问题上，最终发现问题发生的原因是我之前使用双显示器，而上课时只使用了笔记本屏幕，打开的窗口跑到第二屏幕上去了。\n\n另外，Windows系统上遇到除此之外的窗口打不开问题，可以尝试在任务栏图标上停留，然后在缩略图上右击选择最大化，或alt+tab选择不显示的窗口，然后使用win+上方向键。","tags":["Software"]},{"title":"笔记本键盘上某些键（例如break键）消失了怎么办？","url":"/2019/04/29/笔记本键盘上某些键（例如break键）消失了怎么办？/","content":"Pause/Break键在DOS时代很常用，它的主要作用是使程序或服务暂停，同时按下Ctrl，会使得程序或服务停止。在如今的笔记本电脑上，Pause/Break键已经很少见到了，但我们在某些情况下还用得到，那如何找回它呢？\n\n某些厂商使用了组合键来替代Break，例如笔记本电脑可以使用Ctrl+Fn+F11、Fn+B或Ctrl+Fn+B，Ctrl+Fn+P等组合按键；\n\n某些程序里可以使用Ctrl+C进行中断程序；\n\n还有一种方法是可以使用软键盘。Win+R，输入osk，确定，就可以打开了。","tags":["Hardware"]},{"title":"VPS使用Google BBR加速后无法连接网络的解决办法","url":"/2019/03/27/VPS使用Google-BBR加速后无法连接网络的解决办法/","content":"我使用的是美国VPS，系统为CentOS 7，使用下面命令对BBR进行了安装:\n```bash\nyum -y install wget\nwget --no-check-certificate https://github.com/teddysun/across/raw/master/bbr.sh\nchmod +x bbr.sh\n./bbr.sh\n```\n安装结束重启服务器后，再使用SSR就无法连接网络了。原因是VPS端防火墙未关闭，遂使用\n```bash\nsystemctl stop firewalld \nsystemctl disable firewalld \n```\n","tags":["VPS"]},{"title":"刷机重置手机前忘记退出google账号，导致开机卡google验证的解决方法","url":"/2019/03/24/刷机重置手机前忘记退出google账号，导致开机卡google验证的解决方法/","content":"注：此处方法的前提是可以科学上网。\n1.在电脑上将SSR的“允许来自局域网的连接”打上对号；\n![SSR](/img/1.jpg)\n2.打开电脑的移动热点；\n![移动热点](/img/2.jpg)\n3.win+R，输入cmd，使用ipconfig指令找到新的本地连接（一般是最后一个），复制IPv4地址（192.168.137.1）；\n![ip地址](/img/3.jpg)\n4.手机找到电脑的移动热点，输入密码，不要着急连接。点开高级选项，“代理”一项选择“手动”，“代理服务器主机名”一项输入刚才复制的IPv4地址，“代理服务器端口”一项输入SSR设置的本地端口（一般默认是1080），连接wifi；\n5.这时如果没有意外就可以顺利登录google账号了。","tags":["Android"]},{"title":"vim在insert模式使用esc不能切换到命令模式","url":"/2019/03/13/vim在insert模式使用esc不能切换到命令模式/","content":"今天在终端使用vim编辑完文件发现esc键按下后界面会卡住，而不是进入命令模式。起初以为是jupyter notebook的原因，但没搜索到有用的相关信息。再浏览一些网页后，总结有如下可能：\n1. 浏览器问题。键位被截获或浏览器兼容差异。\n2. vim软件包未安装完全。\n\n忽略问题，可以在insert模式下使用ctrl+c键进入命令模式。\n***\n若使用ctrl+z退出会形成swp文件（ls -a可见），可先使用`vim -r xxx.xx`进行恢复，再使用`rm .xxx.xx.swp`进行删除。","tags":["Linux"]}]